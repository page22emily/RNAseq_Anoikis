---
title: "separated_15U_15U"
output: html_document
date: "2023-06-20"
---

is to compare the groups of the anoikis project that have been treated with 15U
Concern was potential overnormalization. Separating these out so that we can see if there are any notable differences 
```{r message= FALSE, warning= FALSE, echo=FALSE}
library(tximport)
library(GenomicFeatures)
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
library(DESeq2)
```

```{r message= FALSE, warning= FALSE, echo=FALSE}
txdb <- loadDb("C:/Users/empage/Documents/Lab_Stuff/Lab_RNAseq_Tutorial/gencode.v19.annotation.gtf_withproteinids.TxDb")
k <- keys(txdb, keytype = "TXNAME")
tx2gene <- select(txdb, k, "GENEID", "TXNAME")
```


```{r message= FALSE, warning= FALSE, echo=FALSE}
dir <- "C:/Users/empage/Documents/Lab_Stuff/Anoikis/OV90/treatment_15U/quants"  #this is a path that you will change. This is the quants folder from Salmon that should be locally on your computer 
samples <- read.csv(file= "C:/Users/empage/Documents/Lab_Stuff/Anoikis/OV90/treatment_15U/meta_15U_only.csv") 
files <- file.path(dir, samples$Sample_ID, "quant.sf")
all(file.exists(files))
```

```{r message= FALSE, warning= FALSE, echo=FALSE}
txi <- tximport(files, type = "salmon", tx2gene= tx2gene, ignoreAfterBar= TRUE)
names(txi)
```


This is for setting up the meta data and DESeq2 object so that you can do your analysis 
```{r message= FALSE, warning= FALSE, echo=FALSE}
sample_meta_data <- read.csv(file= "C:/Users/empage/Documents/Lab_Stuff/Anoikis/OV90/treatment_15U/meta_15U_only.csv") 
sampleFiles <- samples$Sample_ID
sampleCondition <- sample_meta_data$Passage_ID
sampleTable <- data.frame(sampleName = sampleFiles,
                          fileName = sampleFiles,
                          condition = sampleCondition)
sampleTable$condition <- factor(sampleTable$condition)
```


```{r echo=FALSE}
colnames(txi$counts) <- rownames(sampleTable)
```

```{r message= FALSE, warning= FALSE, echo=FALSE}
dds <- DESeqDataSetFromTximport(txi, sampleTable, ~condition)
```

```{r message= FALSE, warning= FALSE, echo=FALSE}
dds <- DESeq(dds)
```

```{r}
counts <- counts(dds[ , ], normalized = TRUE)
write.csv(counts, "~/RNAseq_Anoikis/OV90/RNAseq/15U/counts_15U_only.csv")
```

This is going to tell you information about the results from running DESeq2 
```{r}
res <- results(dds)
res
```

```{r}
summary(res)
```
This is to check that the P1 vs P0 DMSO points are the same as the original comparison for OV90 
```{r}
write.csv(res, "~/RNAseq_Anoikis/OV90/RNAseq/15U/res_P1_vs_P0_15U.csv")
```

Now you can start going through the plot functions and seeing what the data actually looks like 
```{r echo=FALSE}
plotMA(res, ylim=c(-2,2))
```

```{r echo=FALSE}
plotMA(res05, ylim=c(-2,2))
```

```{r}
vsd <- vst(dds, blind=FALSE)
```


```{r}
ntd <- normTransform(dds)
```

```{r}
plotPCA(vsd, intgroup=c("condition"))
```
```{r}
plotDispEsts(dds)
```

```{r echo=FALSE, message= FALSE, warning= FALSE}
library("msigdbr")
library(clusterProfiler)
library(enrichplot)
# we use ggplot2 to add x axis labels (ex: ridgeplot)
library(ggplot2)
library(cowplot)
# SET THE DESIRED ORGANISM HERE
organism = "org.Hs.eg.db"
#BiocManager::install(organism, character.only = TRUE)
library(organism, character.only = TRUE)
```

```{r echo=FALSE, message= FALSE, warning= FALSE}
#to get the gene set that we want
#in this particular setting we want the H genes, which are Hallmark genes 
h_gene_sets = msigdbr(species = "Homo sapiens", category = "H")
```

```{r echo=FALSE, message= FALSE, warning= FALSE}
m_t2g <- msigdbr(species = "Homo sapiens", category = "H") %>% 
  dplyr::select(gs_name, ensembl_gene)
```

#this is from the first go round
```{r echo=FALSE, message= FALSE, warning= FALSE}
# reading in data from deseq2
df = counts
# we want the log2 fold change 
original_gene_list <- df$log2FoldChange

#list needs no decimal points
no_decimals <- gsub('\\.[0-9]*$','', df$X)
#now we are going to add this to the df 
df$no_decimals <- no_decimals
# name the vector
names(original_gene_list) <- df$no_decimals
# omit any NA values
gene_list<-na.omit(original_gene_list)

# sort the list in decreasing order (required for clusterProfiler)
gene_list = sort(gene_list, decreasing = TRUE)
gene.list <- data.frame(gene_list)
```

```{r echo=FALSE, message= FALSE, warning= FALSE}
em <- enricher(df$no_decimals, TERM2GENE=m_t2g)
```

```{r}
gse <- GSEA(gene_list,  minGSSize = 15, 
             maxGSSize = 500, 
             nPermSimple= 1000,
             pvalueCutoff = 1, 
             verbose = TRUE, 
             pAdjustMethod = "BH", TERM2GENE= m_t2g)
```

Extract the data we need 
```{r}
gse_res <- gse@result
write.csv(gse_res, "~/RNAseq_Anoikis/OV90/RNAseq/15U/OV90_15U_gse_P1_vs_P0_1k_perm_pval_1_cutoff_BH.csv")
```