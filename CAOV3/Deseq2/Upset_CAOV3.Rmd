---
title: "Upset_figures_CAOV3"
output: html_document
date: "2023-04-04"
---

#Graphs from Lara with comparisons by group
#they defined up and donw regulation (lfc of 1.5 in this option ) and had the passage comparison.
Need a few things for this to work 
1) On each of the files we are comparing, we need a data column that defines up vs down regulated genes
2) the data of each group 
3) ggplot bar graph for these comparisons 
4) Something on the x axis for what is being compared
5) Make the data make more sense compared to the current figures 

Things I want included in the figure 
ADJUSTED BY THE ADJUSTED P VALUE FIRST. NON SIGNIFICANT P VALS WERE DELETED IN MY NEW FILE 
1) up regulated > LFC 1.5 
2) Down regulated < -1.5 
3) No change as between 1.5 and -1.5 
Bar Graph showing all 3 for each comparison group 
Table showing the percentage of genes in each category 
Files for this are labeled as Comparison Group_Gene_Annotation
Column of interest will be labeled as Group

```{r}
P0_vs_P1 <- read.csv("~/Desktop/CAOV3_Outputs/DESeq2/results_1_vs_0_CAOV3.csv")
P0_vs_P7 <- read.csv("~/Desktop/CAOV3_Outputs/DESeq2/results_7_vs_0_CAOV3.csv")
P0_vs_P6 <- read.csv("~/Desktop/CAOV3_Outputs/DESeq2/results_6_vs_0_CAOV3.csv")

no_decimals <- gsub('\\.[0-9]*$','', P0_vs_P1$X)
P0_vs_P1$X <- no_decimals
no_decimals <- gsub('\\.[0-9]*$','', P0_vs_P6$X)
P0_vs_P6$X <- no_decimals
no_decimals <- gsub('\\.[0-9]*$','', P0_vs_P7$X)
P0_vs_P7$X <- no_decimals
```

those are the raw files. we need to make the only significant ones present 
```{r}
P0_P1_adj <- na.omit(P0_vs_P1)
P0_P7_adj <- na.omit(P0_vs_P7)
P0_P6_adj <- na.omit(P0_vs_P6)
```

```{r}
P0_P1_adj2 <- P0_P1_adj[P0_P1_adj$padj <= .05, ]
P0_P7_adj2 <- P0_P7_adj[P0_P7_adj$padj <= .05, ]
P0_P6_adj2 <- P0_P6_adj[P0_P6_adj$padj <= .05, ]
```

```{r}
library(dplyr)
library(tibble)
# Adding column based on other column:
P0_P1_Annotations <- add_column(P0_P1_adj2 %>%
  mutate(Gene_Annotation = case_when(log2FoldChange <= -1.5 ~ "Down Regulated", log2FoldChange >= 1.5 ~ "Up Regulated", between(log2FoldChange, -1.5 , 1.5) ~ "No Change")))
```

```{r}
P0_P1_Annotations <- add_column(P0_P1_Annotations %>%
  mutate(Down = if_else(log2FoldChange <= -1.5, TRUE, FALSE), .after="Gene_Annotation"))
P0_P1_Annotations <- add_column(P0_P1_Annotations %>%
  mutate(Up = if_else( log2FoldChange >= 1.5, TRUE, FALSE), .after="Down"))
P0_P1_Annotations <- add_column(P0_P1_Annotations %>%
  mutate(NC = if_else(between(log2FoldChange, -1.5 , 1.5), TRUE, FALSE), .after="Up"))
```


```{r}
P0_P6_Annotations <- add_column(P0_P6_adj2 %>%
  mutate(Gene_Annotation = case_when(log2FoldChange <= -1.5 ~ "Down Regulated", log2FoldChange >= 1.5 ~ "Up Regulated", between(log2FoldChange, -1.5 , 1.5) ~ "No Change")))
P0_P6_Annotations <- add_column(P0_P6_Annotations %>%
  mutate(Down = if_else(log2FoldChange <= -1.5, TRUE, FALSE), .after="Gene_Annotation"))
P0_P6_Annotations <- add_column(P0_P6_Annotations %>%
  mutate(Up = if_else(log2FoldChange >= 1.5, TRUE, FALSE), .after="Down"))
P0_P6_Annotations <- add_column(P0_P6_Annotations %>%
  mutate(NC = if_else(between(log2FoldChange, -1.5 , 1.5), TRUE, FALSE), .after="Up"))
```

```{r}
P0_P7_Annotations <- add_column(P0_P7_adj2 %>%
  mutate(Gene_Annotation = case_when(log2FoldChange <= -1.5 ~ "Down Regulated", log2FoldChange >= 1.5 ~ "Up Regulated", between(log2FoldChange, -1.5 , 1.5) ~ "No Change")))
P0_P7_Annotations <- add_column(P0_P7_Annotations %>%
  mutate(Down = if_else(log2FoldChange <= -1.5, TRUE, FALSE), .after="Gene_Annotation"))
P0_P7_Annotations <- add_column(P0_P7_Annotations %>%
  mutate(Up = if_else(log2FoldChange >= 1.5, TRUE, FALSE), .after="Down"))
P0_P7_Annotations <- add_column(P0_P7_Annotations %>%
  mutate(NC = if_else(between(log2FoldChange, -1.5 , 1.5), TRUE, FALSE), .after="Up"))
```


```{r}
P1_Up <- P0_P1_Annotations[ , c(1,10)]
P1_Down <- P0_P1_Annotations[ , c(1,9)]
P1_NC <- P0_P1_Annotations[ , c(1,11)]
P6_Up <- P0_P6_Annotations[ , c(1,10)]
P6_Down <- P0_P6_Annotations[ , c(1,9)]
P6_NC <- P0_P6_Annotations[ , c(1,11)]
P7_Up <- P0_P7_Annotations[ , c(1,10)]
P7_Down <- P0_P7_Annotations[ , c(1,9)]
P7_NC <- P0_P7_Annotations[ , c(1,11)]
colnames(P1_Up) <- c("gene_id", "P0_vs_P1")
colnames(P1_Down) <- c("gene_id", "P0_vs_P1")
colnames(P1_NC) <- c("gene_id", "P0_vs_P1")
colnames(P6_Up) <- c("gene_id", "P0_vs_P6")
colnames(P6_Down) <- c("gene_id", "P0_vs_P6")
colnames(P6_NC) <- c("gene_id", "P0_vs_P6")
colnames(P7_Up) <- c("gene_id", "P0_vs_P7")
colnames(P7_Down) <- c("gene_id", "P0_vs_P7")
colnames(P7_NC) <- c("gene_id", "P0_vs_P7")
```

```{r}
Up_Genes2 <- merge(P1_Up, P6_Up, all.x=TRUE, all= TRUE)
Up_Genes<- merge(Up_Genes2, P7_Up, all.x=TRUE, all= TRUE)
```

```{r}
Down_Genes2 <- merge(P1_Down, P6_Down, all.x=TRUE, all= TRUE)
Down_Genes<- merge(Down_Genes2, P7_Down, all.x=TRUE, all= TRUE)
```

```{r}
NC_Genes2 <- merge(P1_NC, P6_NC, all.x=TRUE, all= TRUE)
NC_Genes<- merge(NC_Genes2, P7_NC, all.x=TRUE, all= TRUE)
```

```{r}
library(tidyr)
#read in what we want 
up <- Up_Genes
down <- Down_Genes
nc <- NC_Genes
```

#The rest of Lara's figure is made with UpSet Figures 
## Need to use ComplexUpSet because the other one is out of date (yay Lara for telling me)
```{r}
library(ggplot2)
library(ComplexUpset)
```

#THIS WORKED TO MAKE THE RIGHT DATASET. Hopefully 
```{r}
Group <- colnames(up)[c(2:4)]
Group
```

```{r}
upset(up, Group, min_degree=1, sort_sets= FALSE, sort_intersections_by='degree', sort_intersections= "ascending") + ggtitle('Up Regulated Genes') 
ggsave("~/Desktop/Up_CAOV3.tiff", last_plot())
```

```{r}
upset(up, Group, min_degree=1, sort_sets= FALSE, sort_intersections_by='degree', sort_intersections= "ascending") + ggtitle('Up Regulated Genes') 
ggsave("~/Desktop/Up_CAOV3_no_labels.tiff", last_plot())
```

```{r}
upset(down, Group,  min_degree=1, sort_sets= FALSE, sort_intersections_by='degree', sort_intersections= "ascending") + ggtitle("Down Regulated Genes")
ggsave("~/Desktop/Down_CAOV3.tiff", last_plot())
```

```{r}
upset(down, Group,  min_degree=1, sort_sets= FALSE, sort_intersections_by='degree', sort_intersections= "ascending", base_annotations= list('Size'=(intersection_size(counts=FALSE)))) + ggtitle("Down Regulated Genes")
ggsave("~/Desktop/Down_CAOV3_no_labels.tiff", last_plot())
```

```{r}
upset(nc, Group, min_degree=1, sort_sets= FALSE, sort_intersections_by='degree', sort_intersections= "ascending", base_annotations= list('Size'=(intersection_size(counts=FALSE)))) + ggtitle("Genes with No Significant Change")
ggsave("~/Desktop/NC_CAOV3.tiff", last_plot())
```

```{r}
upset(nc, Group, min_degree=1, sort_sets= FALSE, sort_intersections_by='degree', sort_intersections= "ascending", base_annotations= list('Size'=(intersection_size(counts=FALSE)))) + ggtitle("Genes with No Significant Change")
ggsave("~/Desktop/NC_CAOV3_no_labels.tiff", last_plot())
```

